import streamlit as st
import pandas as pd
from datetime import datetime
import os
import json

# --- ุฅุนุฏุงุฏุงุช ---
DATA_FILE = "data.json"

# --- ุฏูุงู ุงููุณุงุนุฏุฉ ---
def load_data():
    if os.path.exists(DATA_FILE):
        with open(DATA_FILE, "r", encoding="utf-8") as f:
            data = json.load(f).get("entries", [])
            df = pd.DataFrame(data)
            # ุชุญููู ุงูุชุงุฑูุฎ ูุงูููุช ุฅูู ุตูุบุฉ ูููู ูู Streamlit ุงูุชุนุงูู ูุนูุง
            df['ุงูุชุงุฑูุฎ ุงููููุงุฏู'] = pd.to_datetime(df['ุงูุชุงุฑูุฎ ุงููููุงุฏู'], errors='coerce')
            return df
    else:
        return pd.DataFrame(columns=[
            "ุงูุชุงุฑูุฎ ุงููููุงุฏู", "ููุช ุงูุฏุฎูู", "ููุช ุงูุฎุฑูุฌ",
            "ุนุฏุฏ ุงูุณุงุนุงุช", "ุงูุณุงุนุงุช ุงูุนุงุฏูุฉ", "ุงูุณุงุนุงุช ุงูุฅุถุงููุฉ",
            "ุชูููุฉ ุงูุนุงุฏูุฉ", "ุชูููุฉ ุงูุฅุถุงููุฉ", "ุงูุชูููุฉ ุงููููุฉ", "ุงูุณุงุนุงุช ุงููุญุชุณุจุฉ"
        ])

def save_data(df):
    data = {"entries": df.to_dict(orient="records")}
    with open(DATA_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

# --- ูุงุฌูุฉ ุงููุณุชุฎุฏู ---
st.set_page_config(layout="wide")
st.title("ุญุงุณุจุฉ ุงููุฑุชุจุงุช - ูุน ุฏุนู JSON")

st.markdown("ููููู ุฅุถุงูุฉ ุฃู ุชุนุฏูู ุงูุจูุงูุงุช ุฃุฏูุงู. ูุชู ุญูุธ ุงูุจูุงูุงุช ูู ููู `data.json`. ููููู ุฅุถุงูุฉ ุฃูุงู ุฌุฏูุฏุฉ ุดูุฑููุง.")

# --- ุชุญููู ุงูุจูุงูุงุช ---
df = load_data()

# --- ูุนุงูุฌุฉ ุงูุจูุงูุงุช ---
if not df.empty:
    # ุงุณุชุจุฏุงู ุงูููู ุบูุฑ ุงูุตุงูุญุฉ
    df['ุงูุชุงุฑูุฎ ุงููููุงุฏู'] = pd.to_datetime(df['ุงูุชุงุฑูุฎ ุงููููุงุฏู'], errors='coerce').dt.strftime('%Y-%m-%d')
    df['ุงูุชุงุฑูุฎ ุงููููุงุฏู'] = pd.to_datetime(df['ุงูุชุงุฑูุฎ ุงููููุงุฏู'], errors='coerce')

    # ุงุณุชุจุฏุงู NaN ุจุงูููู ุงูุงูุชุฑุงุถูุฉ
    df.fillna({
        'ููุช ุงูุฏุฎูู': '00:00',
        'ููุช ุงูุฎุฑูุฌ': '00:00',
        'ุนุฏุฏ ุงูุณุงุนุงุช': 0,
        'ุงูุณุงุนุงุช ุงูุนุงุฏูุฉ': 0,
        'ุงูุณุงุนุงุช ุงูุฅุถุงููุฉ': 0,
        'ุชูููุฉ ุงูุนุงุฏูุฉ': 0,
        'ุชูููุฉ ุงูุฅุถุงููุฉ': 0,
        'ุงูุชูููุฉ ุงููููุฉ': 0,
        'ุงูุณุงุนุงุช ุงููุญุชุณุจุฉ': 0
    }, inplace=True)

# --- ุฌุฏูู ุงูุชุญุฑูุฑ ---
st.subheader("ุชุญุฑูุฑ ุงูุจูุงูุงุช")
edited_df = st.data_editor(
    df,
    num_rows="dynamic",
    column_config={
        "ุงูุชุงุฑูุฎ ุงููููุงุฏู": st.column_config.DateColumn("ุงูุชุงุฑูุฎ ุงููููุงุฏู", format="YYYY-MM-DD"),
        "ููุช ุงูุฏุฎูู": st.column_config.TextColumn("ููุช ุงูุฏุฎูู", default="00:00"),
        "ููุช ุงูุฎุฑูุฌ": st.column_config.TextColumn("ููุช ุงูุฎุฑูุฌ", default="00:00"),
        "ุนุฏุฏ ุงูุณุงุนุงุช": st.column_config.NumberColumn("ุนุฏุฏ ุงูุณุงุนุงุช", step=0.1),
        "ุงูุณุงุนุงุช ุงูุนุงุฏูุฉ": st.column_config.NumberColumn("ุงูุณุงุนุงุช ุงูุนุงุฏูุฉ", step=0.1),
        "ุงูุณุงุนุงุช ุงูุฅุถุงููุฉ": st.column_config.NumberColumn("ุงูุณุงุนุงุช ุงูุฅุถุงููุฉ", step=0.1),
        "ุชูููุฉ ุงูุนุงุฏูุฉ": st.column_config.NumberColumn("ุชูููุฉ ุงูุนุงุฏูุฉ", step=1.0),
        "ุชูููุฉ ุงูุฅุถุงููุฉ": st.column_config.NumberColumn("ุชูููุฉ ุงูุฅุถุงููุฉ", step=1.0),
        "ุงูุชูููุฉ ุงููููุฉ": st.column_config.NumberColumn("ุงูุชูููุฉ ุงููููุฉ", step=1.0),
        "ุงูุณุงุนุงุช ุงููุญุชุณุจุฉ": st.column_config.NumberColumn("ุงูุณุงุนุงุช ุงููุญุชุณุจุฉ", step=0.1)
    },
    use_container_width=True
)

# --- ุฒุฑ ุงูุญูุธ ---
if st.button("๐พ ุญูุธ ุงูุจูุงูุงุช"):
    # ุชุญููู ุงูุชุงุฑูุฎ ูุฑุฉ ุฃุฎุฑู ุฅูู ุตูุบุฉ DateTime
    edited_df['ุงูุชุงุฑูุฎ ุงููููุงุฏู'] = pd.to_datetime(edited_df['ุงูุชุงุฑูุฎ ุงููููุงุฏู'], errors='coerce')
    edited_df.fillna({
        'ููุช ุงูุฏุฎูู': '00:00',
        'ููุช ุงูุฎุฑูุฌ': '00:00',
        'ุนุฏุฏ ุงูุณุงุนุงุช': 0,
        'ุงูุณุงุนุงุช ุงูุนุงุฏูุฉ': 0,
        'ุงูุณุงุนุงุช ุงูุฅุถุงููุฉ': 0,
        'ุชูููุฉ ุงูุนุงุฏูุฉ': 0,
        'ุชูููุฉ ุงูุฅุถุงููุฉ': 0,
        'ุงูุชูููุฉ ุงููููุฉ': 0,
        'ุงูุณุงุนุงุช ุงููุญุชุณุจุฉ': 0
    }, inplace=True)

    # ุญูุธ ุงูุจูุงูุงุช
    data_to_save = edited_df.copy()
    data_to_save['ุงูุชุงุฑูุฎ ุงููููุงุฏู'] = data_to_save['ุงูุชุงุฑูุฎ ุงููููุงุฏู'].dt.strftime('%Y-%m-%d')
    save_data(data_to_save)
    st.success("โ ุชู ุญูุธ ุงูุจูุงูุงุช ุจูุฌุงุญ ูู ููู data.json")